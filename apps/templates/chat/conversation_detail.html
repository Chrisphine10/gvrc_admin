{% extends 'layouts/base.html' %}

{% block title %} Chat Conversation - {{ conversation.subject|default:"Emergency Chat" }} {% endblock title %}

<!-- Specific CSS goes HERE -->
{% block stylesheets %}
<style>
  .chat-container {
    height: calc(100vh - 300px);
    display: flex;
    flex-direction: column;
    position: relative;
  }
  
  .chat-header {
    background: #f8f9fa;
    border-radius: 0.5rem 0.5rem 0 0;
    padding: 0.5rem 1rem;
    border-bottom: 1px solid #e9ecef;
    flex-shrink: 0;
  }
  
  .chat-status-info {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }
  
  .chat-status-info .badge {
    font-size: 0.7rem;
    padding: 0.25rem 0.5rem;
  }
  
  .quick-actions-buttons {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }
  
  .quick-actions-buttons .btn {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
  }
  
  .chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 0.5rem;
    background: #fff;
    margin-bottom: 50px; /* Space for fixed input */
  }
  
  .chat-input {
    background: #f8f9fa;
    border-radius: 0 0 0.5rem 0.5rem;
    padding: 0.5rem;
    border-top: 1px solid #e9ecef;
    position: fixed;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: calc(100% - 2rem);
    max-width: 1200px;
    z-index: 1000;
    box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
  }
  
  .input-container {
    max-width: 800px;
    margin: 0 auto;
  }
  
  .input-group {
    background: white;
    border-radius: 0.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    overflow: hidden;
  }
  
  .input-group .form-control {
    border: none;
    padding: 0.4rem 0.8rem;
    font-size: 0.85rem;
    border-radius: 0;
  }
  
  .input-group .form-control:focus {
    box-shadow: none;
    border: none;
  }
  
  .send-btn {
    border: none;
    padding: 0.4rem 0.8rem;
    border-radius: 0;
    font-weight: 500;
    font-size: 0.85rem;
  }
  
  .input-hint {
    display: none;
  }
  
     /* Responsive adjustments */
   @media (max-width: 768px) {
     .chat-input {
       width: calc(100% - 1rem);
       padding: 0.5rem;
     }
     
     .conversation-meta {
       flex-direction: column;
       gap: 0.5rem;
     }
     
     .actions-container {
       flex-direction: column;
       align-items: center;
     }
     
     .quick-action-btn {
       width: 100%;
       max-width: 200px;
     }
     
           .chat-messages {
        margin-bottom: 70px;
      }
   }
  
  /* Loading state improvements */
  .text-center.text-muted {
    padding: 3rem 1rem;
  }
  
  .text-center.text-muted i {
    color: #6c757d;
    margin-bottom: 1rem;
  }
  
  /* Scrollbar styling */
  .chat-messages::-webkit-scrollbar {
    width: 8px;
  }
  
  .chat-messages::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
  }
  
  .chat-messages::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
  }
  
  .chat-messages::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
  }
  
  .message {
    margin-bottom: 0.5rem;
    display: flex;
    align-items: flex-start;
  }
  
  .message.mobile {
    justify-content: flex-start;
  }
  
  .message.admin {
    justify-content: flex-end;
  }
  
  .message-content {
    max-width: 70%;
    padding: 0.4rem 0.6rem;
    border-radius: 0.4rem;
    position: relative;
    word-wrap: break-word;
  }
  
  .message.mobile .message-content {
    background: #e3f2fd;
    color: #1565c0;
    border: 1px solid #bbdefb;
  }
  
  .message.admin .message-content {
    background: #e8f5e8;
    color: #2e7d32;
    border: 1px solid #c8e6c9;
  }
  
  .message-time {
    font-size: 0.7rem;
    color: #6c757d;
    margin-top: 0.2rem;
    text-align: right;
  }
  
  .message.mobile .message-time {
    text-align: left;
  }
  
  /* Media message styles */
  .media-message {
    max-width: 300px;
  }
  
  .media-message img {
    max-width: 100%;
    height: auto;
    border-radius: 0.3rem;
    cursor: pointer;
    transition: transform 0.2s ease;
  }
  
  .media-message img:hover {
    transform: scale(1.05);
  }
  
  .media-message video {
    max-width: 100%;
    height: auto;
    border-radius: 0.3rem;
    cursor: pointer;
  }
  
  .media-message .file-info {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem;
    background: rgba(0,0,0,0.05);
    border-radius: 0.3rem;
    margin-top: 0.5rem;
  }
  
  .media-message .file-icon {
    font-size: 1.2rem;
    color: #6c757d;
  }
  
  .media-message .file-details {
    flex: 1;
  }
  
  .media-message .file-name {
    font-weight: 500;
    font-size: 0.8rem;
    color: #495057;
    margin-bottom: 0.1rem;
  }
  
  .media-message .file-size {
    font-size: 0.7rem;
    color: #6c757d;
  }
  
  .media-message .download-btn {
    padding: 0.2rem 0.5rem;
    font-size: 0.7rem;
    border-radius: 0.2rem;
    background: #007bff;
    color: white;
    border: none;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
  }
  
  .media-message .download-btn:hover {
    background: #0056b3;
    color: white;
    text-decoration: none;
  }
  
  /* Media modal */
  .media-modal {
    display: none;
    position: fixed;
    z-index: 2000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.9);
  }
  
  .media-modal.show {
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .media-modal-content {
    max-width: 90%;
    max-height: 90%;
    position: relative;
  }
  
  .media-modal-content img,
  .media-modal-content video {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
  }
  
  .media-modal-close {
    position: absolute;
    top: -40px;
    right: 0;
    color: white;
    font-size: 2rem;
    font-weight: bold;
    cursor: pointer;
  }
  
  .media-modal-close:hover {
    color: #ccc;
  }
  
  /* File preview styles */
  #file-preview .alert {
    margin-bottom: 0;
    padding: 0.5rem;
    font-size: 0.8rem;
  }
  
  #file-preview .btn {
    padding: 0.2rem 0.5rem;
    font-size: 0.7rem;
  }
  
  /* Enhanced input group for file upload */
  .input-group .btn-outline-secondary {
    border: 1px solid #dee2e6;
    color: #6c757d;
  }
  
  .input-group .btn-outline-secondary:hover {
    background-color: #6c757d;
    border-color: #6c757d;
    color: white;
  }
  
  .conversation-info {
    background: #f8f9fa;
    border-radius: 0.5rem;
    padding: 0.75rem;
    margin-bottom: 0.75rem;
    border: 1px solid #dee2e6;
  }
  
  .conversation-header h5 {
    color: #2c3e50;
    font-weight: 600;
    font-size: 1rem;
    margin-bottom: 0.5rem;
  }
  
  .conversation-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }
  
  .meta-item {
    display: flex;
    align-items: center;
    background: white;
    padding: 0.4rem 0.6rem;
    border-radius: 0.25rem;
    border: 1px solid #e9ecef;
    font-size: 0.8rem;
  }
  
  .meta-label {
    font-weight: 600;
    color: #6c757d;
    margin-right: 0.25rem;
  }
  
  .meta-value {
    font-weight: 500;
    color: #495057;
  }
  

  

  
  .typing-indicator {
    display: none;
    padding: 0.5rem 1rem;
    color: #6c757d;
    font-style: italic;
  }
  
  .typing-indicator.show {
    display: block;
  }
  
  .message-status {
    font-size: 0.75rem;
    color: #6c757d;
    margin-top: 0.25rem;
  }
  
  .unread-indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background-color: #dc3545;
    display: inline-block;
    margin-right: 8px;
  }
  

</style>
{% endblock stylesheets %}

{% block content %}

               <!-- Header -->
      <div class="header bg-gradient-danger pb-2">
        <div class="container-fluid">
          <div class="header-body">
            <div class="row align-items-center py-1">
              <div class="col-lg-6 col-7">
                <h6 class="h5 text-white d-inline-block mb-0">
                  <i class="fas fa-comments me-2"></i>
                  Emergency Chat
                </h6>
              </div>
                            <div class="col-lg-6 col-5 text-right">
                 <button class="btn btn-sm btn-info me-2" onclick="exportConversation()">
                   <i class="fas fa-download me-1"></i>Export
                 </button>
                 <a href="{% url 'chat:conversation_list' %}" class="btn btn-sm btn-neutral">
                   <i class="fas fa-arrow-left me-1"></i>Back
                 </a>
               </div>
            </div>
          </div>
        </div>
      </div>

          <!-- Page content -->
      <div class="container-fluid mt--2">
      
             <!-- Conversation Info -->
       <div class="conversation-info">
         <div class="row">
           <div class="col-12">
             <div class="conversation-header">
               <h5 class="mb-2">
                 <span class="unread-indicator" id="unread-indicator" style="display: none;"></span>
                 {{ conversation.subject|default:"Emergency Chat" }}
               </h5>
               <div class="conversation-meta">
                 <div class="meta-item">
                   <i class="fas fa-mobile-alt me-2 text-info"></i>
                   <span class="meta-label">Device:</span>
                   <span class="meta-value">{{ conversation.mobile_session.device_id }}</span>
                 </div>
                 <div class="meta-item">
                   <i class="fas fa-calendar me-2 text-info"></i>
                   <span class="meta-label">Created:</span>
                   <span class="meta-value">{{ conversation.created_at|date:"M d, Y H:i" }}</span>
                 </div>
                 <div class="meta-item">
                   <i class="fas fa-clock me-2 text-info"></i>
                   <span class="meta-label">Last Activity:</span>
                   <span class="meta-value">{{ conversation.last_message_at|date:"M d, Y H:i"|default:"Never" }}</span>
                 </div>
               </div>
             </div>
           </div>
         </div>
       </div>

      <!-- Chat Interface -->
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-body p-0">
              <div class="chat-container">
                                                   <!-- Chat Header -->
                  <div class="chat-header">
                    <div class="d-flex justify-content-between align-items-center">
                      <div>
                        <h6 class="mb-0">Chat Messages</h6>
                        <small class="text-muted" id="message-count">0 messages</small>
                        <div class="chat-status-info mt-1">
                          <span class="badge bg-{% if conversation.status == 'new' %}info{% elif conversation.status == 'active' %}success{% elif conversation.status == 'resolved' %}secondary{% elif conversation.status == 'closed' %}danger{% else %}secondary{% endif %} me-2">
                            Status: {{ conversation.status|title }}
                          </span>
                          <span class="badge bg-{% if conversation.priority == 'urgent' %}danger{% elif conversation.priority == 'high' %}warning{% elif conversation.priority == 'medium' %}info{% elif conversation.priority == 'low' %}success{% else %}info{% endif %} me-2">
                            Priority: {{ conversation.priority|title }}
                          </span>
                          <span class="badge bg-{% if conversation.assigned_admin %}success{% else %}warning{% endif %}">
                            Assignment: {% if conversation.assigned_admin %}{{ conversation.assigned_admin.username }}{% else %}None{% endif %}
                          </span>
                        </div>
                      </div>
                                             <div class="d-flex align-items-center gap-2">
                         <div class="quick-actions-buttons">
                           {% if not conversation.assigned_admin %}
                             <button class="btn btn-sm btn-success" onclick="assignToSelf()">
                               <i class="fas fa-user-plus me-1"></i>Assign
                             </button>
                           {% endif %}
                           {% if conversation.status == 'active' %}
                             <button class="btn btn-sm btn-warning" onclick="updateStatus('resolved')">
                               <i class="fas fa-check me-1"></i>Resolve
                             </button>
                           {% endif %}
                           {% if conversation.status != 'closed' %}
                             <button class="btn btn-sm btn-danger" onclick="updateStatus('closed')">
                               <i class="fas fa-times me-1"></i>Close
                             </button>
                           {% endif %}
                         </div>
                         <span class="badge bg-success" id="connection-status">Connected</span>
                       </div>
                    </div>
                  </div>

                <!-- Chat Messages -->
                <div class="chat-messages" id="chat-messages">
                  <!-- Messages will be loaded here dynamically -->
                  <div class="text-center text-muted">
                    <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                    <p>Loading messages...</p>
                  </div>
                </div>

                <!-- Typing Indicator -->
                <div class="typing-indicator" id="typing-indicator">
                  <i class="fas fa-ellipsis"></i> Mobile user is typing...
                </div>

                                                  <!-- Chat Input -->
                  <div class="chat-input">
                    <div class="input-container">
                      <div class="input-group">
                        <input type="text" 
                               class="form-control" 
                               id="message-input" 
                               placeholder="Type your message here..." 
                               onkeypress="handleKeyPress(event)"
                               autocomplete="off">
                        <button class="btn btn-outline-secondary" type="button" onclick="document.getElementById('file-input').click()">
                          <i class="fas fa-paperclip"></i>
                        </button>
                        <button class="btn btn-primary send-btn" type="button" onclick="sendMessage()">
                          <i class="fas fa-paper-plane me-1"></i>
                          Send
                        </button>
                      </div>
                      <input type="file" 
                             id="file-input" 
                             style="display: none;" 
                             accept="image/*,video/*,.pdf,.doc,.docx,.xls,.xlsx,.txt,.zip,.rar,.mp3,.wav"
                             onchange="handleFileUpload(event)">
                      <div id="file-preview" class="mt-2" style="display: none;"></div>
                    </div>
                  </div>
              </div>
            </div>
          </div>
        </div>
      </div>

         </div>

     <!-- Media Modal -->
     <div class="media-modal" id="mediaModal">
       <div class="media-modal-content">
         <span class="media-modal-close" onclick="closeMediaModal()">&times;</span>
         <div id="mediaModalContent"></div>
       </div>
     </div>

 {% endblock content %}

<!-- Specific JS goes HERE -->
{% block javascripts %}
<script>
  const conversationId = "{{ conversation.conversation_id }}";
  let lastMessageId = 0;
  let isTyping = false;
  let typingTimeout;

  // Load messages on page load
  document.addEventListener('DOMContentLoaded', function() {
    loadMessages();
    startMessagePolling();
    updateUnreadIndicator();
  });

  // Load messages
  function loadMessages() {
    fetch(`/chat/admin/conversations/${conversationId}/messages/`, {
      headers: {
        'X-CSRFToken': getCookie('csrftoken'),
        'Content-Type': 'application/json',
      }
    })
    .then(response => response.json())
    .then(data => {
      console.log('DEBUG: Messages data received:', data);
      if (data.results && data.results.length > 0) {
        console.log('DEBUG: First message:', data.results[0]);
        console.log('DEBUG: First message media_file_url:', data.results[0].media_file_url);
        console.log('DEBUG: First message media_file:', data.results[0].media_file);
        console.log('DEBUG: First message message_type:', data.results[0].message_type);
      }
      
      displayMessages(data.results || data);
      updateMessageCount(data.results?.length || data.length || 0);
      
      if (data.results && data.results.length > 0) {
        lastMessageId = Math.max(...data.results.map(m => m.message_id));
      }
    })
    .catch(error => {
      console.error('Error loading messages:', error);
      showToast('Error loading messages', 'error');
    });
  }

  // Display messages
  function displayMessages(messages) {
    const container = document.getElementById('chat-messages');
    
    if (messages.length === 0) {
      container.innerHTML = `
        <div class="text-center text-muted">
          <i class="fas fa-comments fa-2x mb-2"></i>
          <p>No messages yet. Start the conversation!</p>
        </div>
      `;
      return;
    }

    container.innerHTML = messages.map(message => createMessageHTML(message)).join('');
    
    // Scroll to bottom
    container.scrollTop = container.scrollHeight;
  }

     // Create message HTML
   function createMessageHTML(message) {
     const isAdmin = message.sender_type === 'admin';
     const messageClass = isAdmin ? 'admin' : 'mobile';
     const timeAgo = formatTimeAgo(message.sent_at);
     
     // Debug logging for media messages
     if (message.message_type !== 'text') {
       console.log('DEBUG: Processing media message:', message);
       console.log('DEBUG: message_type:', message.message_type);
       console.log('DEBUG: media_file_url:', message.media_file_url);
       console.log('DEBUG: media_file:', message.media_file);
       console.log('DEBUG: media_url:', message.media_url);
     }
     
     let contentHTML = '';
     
     // Handle different message types
     if (message.message_type === 'image' && (message.media_file_url || message.media_url)) {
       const mediaSource = message.media_file_url || message.media_url;
       contentHTML = `
         <div class="media-message">
           <img src="${mediaSource}" alt="Image" onclick="openMediaModal('${mediaSource}', 'image')">
           <div class="file-info">
             <i class="fas fa-image file-icon"></i>
             <div class="file-details">
               <div class="file-name">${message.metadata?.file_name || 'Image'}</div>
               <div class="file-size">${formatFileSize(message.metadata?.file_size || 0)}</div>
             </div>
             <a href="${mediaSource}" class="download-btn" download>
               <i class="fas fa-download"></i>
             </a>
           </div>
         </div>
       `;
     } else if (message.message_type === 'video' && (message.media_file_url || message.media_url)) {
       const mediaSource = message.media_file_url || message.media_url;
       contentHTML = `
         <div class="media-message">
           <video controls onclick="openMediaModal('${mediaSource}', 'video')">
             <source src="${mediaSource}" type="video/mp4">
             Your browser does not support the video tag.
           </video>
           <div class="file-info">
             <i class="fas fa-video file-icon"></i>
             <div class="file-details">
               <div class="file-name">${message.metadata?.file_name || 'Video'}</div>
               <div class="file-size">${formatFileSize(message.metadata?.file_size || 0)}</div>
             </div>
             <a href="${mediaSource}" class="download-btn" download>
               <i class="fas fa-download"></i>
             </a>
           </div>
         </div>
       `;
     } else if (message.message_type === 'file' && (message.media_file_url || message.media_url)) {
       const mediaSource = message.media_file_url || message.media_url;
       const fileName = message.metadata?.file_name || 'File';
       const fileSize = formatFileSize(message.metadata?.file_size || 0);
       const fileIcon = getFileIcon(fileName);
       
       contentHTML = `
         <div class="media-message">
           <div class="file-info">
             <i class="${fileIcon} file-icon"></i>
             <div class="file-details">
               <div class="file-name">${escapeHtml(fileName)}</div>
               <div class="file-size">${fileSize}</div>
             </div>
             <a href="${mediaSource}" class="download-btn" download>
               <i class="fas fa-download"></i>
             </a>
           </div>
         </div>
       `;
     } else if (message.message_type === 'voice' && (message.media_file_url || message.media_url)) {
       const mediaSource = message.media_file_url || message.media_url;
       contentHTML = `
         <div class="media-message">
           <audio controls>
             <source src="${mediaSource}" type="audio/mpeg">
             Your browser does not support the audio tag.
           </audio>
           <div class="file-info">
             <i class="fas fa-microphone file-icon"></i>
             <div class="file-details">
               <div class="file-name">${message.metadata?.file_name || 'Voice Message'}</div>
               <div class="file-size">${formatFileSize(message.metadata?.file_size || 0)}</div>
             </div>
             <a href="${mediaSource}" class="download-btn" download>
               <i class="fas fa-download"></i>
             </a>
           </div>
         </div>
       `;
     } else {
       // Regular text message
       contentHTML = `<div>${escapeHtml(message.content)}</div>`;
     }
     
     return `
       <div class="message ${messageClass}">
         <div class="message-content ${message.message_type !== 'text' ? 'media-message' : ''}">
           ${contentHTML}
           <div class="message-time">${timeAgo}</div>
           <div class="message-status">${getMessageStatus(message.status)}</div>
         </div>
       </div>
     `;
   }

  // Send message
  function sendMessage() {
    const input = document.getElementById('message-input');
    const content = input.value.trim();
    
    if (!content) return;
    
    // Clear input
    input.value = '';
    
    // Add message to UI immediately (optimistic update)
    const tempMessage = {
      message_id: Date.now(),
      content: content,
      sender_type: 'admin',
      sent_at: new Date().toISOString(),
      status: 'sent'
    };
    
    appendMessage(tempMessage);
    
    // Send to API
    fetch(`/chat/admin/conversations/${conversationId}/send-message/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCookie('csrftoken'),
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ content: content })
    })
    .then(response => response.json())
    .then(data => {
      // Update the temporary message with real data
      updateMessage(tempMessage.message_id, data);
    })
    .catch(error => {
      console.error('Error sending message:', error);
      showToast('Error sending message', 'error');
      
      // Remove the temporary message
      removeMessage(tempMessage.message_id);
    });
  }

  // Append message to chat
  function appendMessage(message) {
    const container = document.getElementById('chat-messages');
    const messageHTML = createMessageHTML(message);
    
    // Remove "no messages" message if it exists
    const noMessagesDiv = container.querySelector('.text-center.text-muted');
    if (noMessagesDiv) {
      noMessagesDiv.remove();
    }
    
    container.insertAdjacentHTML('beforeend', messageHTML);
    container.scrollTop = container.scrollHeight;
    
    updateMessageCount(parseInt(document.getElementById('message-count').textContent) + 1);
  }

  // Update message
  function updateMessage(tempId, realMessage) {
    const container = document.getElementById('chat-messages');
    const tempMessageDiv = container.querySelector(`[data-temp-id="${tempId}"]`);
    
    if (tempMessageDiv) {
      tempMessageDiv.outerHTML = createMessageHTML(realMessage);
    }
  }

  // Remove message
  function removeMessage(tempId) {
    const container = document.getElementById('chat-messages');
    const tempMessageDiv = container.querySelector(`[data-temp-id="${tempId}"]`);
    
    if (tempMessageDiv) {
      tempMessageDiv.remove();
      updateMessageCount(parseInt(document.getElementById('message-count').textContent) - 1);
    }
  }

  // Handle key press in message input
  function handleKeyPress(event) {
    if (event.key === 'Enter') {
      sendMessage();
    }
  }

  // Start message polling
  function startMessagePolling() {
    setInterval(() => {
      checkNewMessages();
    }, 5000); // Check every 5 seconds
  }

  // Check for new messages
  function checkNewMessages() {
    if (lastMessageId === 0) return;
    
    fetch(`/chat/admin/conversations/${conversationId}/messages/?after=${lastMessageId}`, {
      headers: {
        'X-CSRFToken': getCookie('csrftoken'),
        'Content-Type': 'application/json',
      }
    })
    .then(response => response.json())
    .then(data => {
      const newMessages = data.results || data;
      
      if (newMessages.length > 0) {
        newMessages.forEach(message => {
          if (message.message_id > lastMessageId) {
            appendMessage(message);
            lastMessageId = Math.max(lastMessageId, message.message_id);
          }
        });
        
        // Mark messages as read
        markMessagesAsRead();
      }
    })
    .catch(error => {
      console.error('Error checking new messages:', error);
    });
  }

  // Mark messages as read
  function markMessagesAsRead() {
    fetch(`/chat/admin/conversations/${conversationId}/messages/read/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCookie('csrftoken'),
        'Content-Type': 'application/json',
      }
    })
    .then(() => {
      updateUnreadIndicator();
    })
    .catch(error => {
      console.error('Error marking messages as read:', error);
    });
  }

  // Update unread indicator
  function updateUnreadIndicator() {
    fetch(`/chat/admin/conversations/${conversationId}/`, {
      headers: {
        'X-CSRFToken': getCookie('csrftoken'),
        'Content-Type': 'application/json',
      }
    })
    .then(response => response.json())
    .then(data => {
      const unreadIndicator = document.getElementById('unread-indicator');
      if (data.unread_count_admin > 0) {
        unreadIndicator.style.display = 'inline-block';
      } else {
        unreadIndicator.style.display = 'none';
      }
    })
    .catch(error => {
      console.error('Error updating unread indicator:', error);
    });
  }

  // Update message count
  function updateMessageCount(count) {
    document.getElementById('message-count').textContent = `${count} message${count !== 1 ? 's' : ''}`;
  }

  // Format time ago
  function formatTimeAgo(timeString) {
    if (!timeString) return 'Unknown';
    const date = new Date(timeString);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins}m ago`;
    if (diffHours < 24) return `${diffHours}h ago`;
    if (diffDays < 7) return `${diffDays}d ago`;
    return date.toLocaleDateString();
  }

  // Get message status
  function getMessageStatus(status) {
    const statusMap = {
      'sent': 'Sent',
      'delivered': 'Delivered',
      'read': 'Read',
      'failed': 'Failed'
    };
    return statusMap[status] || status;
  }

  // Escape HTML
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Refresh messages
  function refreshMessages() {
    loadMessages();
  }

    // Assign conversation to self
  function assignToSelf() {
    fetch(`/chat/conversation/${conversationId}/assign/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCookie('csrftoken'),
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ admin_id: 'self' })
    })
    .then(response => response.json())
    .then(data => {
      showToast('Conversation assigned to you', 'success');
      location.reload(); // Refresh to show new assignment
    })
    .catch(error => {
      console.error('Error assigning conversation:', error);
      showToast('Error assigning conversation', 'error');
    });
  }
  
  // Update conversation status
  function updateStatus(status) {
    fetch(`/chat/conversation/${conversationId}/status/`, {
      method: 'PATCH',
      headers: {
        'X-CSRFToken': getCookie('csrftoken'),
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ status: status })
    })
    .then(response => response.json())
    .then(data => {
      showToast(`Status updated to ${status}`, 'success');
      location.reload(); // Refresh to show new status
    })
    .catch(error => {
      console.error('Error updating status:', error);
      showToast('Error updating status', 'error');
    });
  }

  // Export conversation
  function exportConversation() {
    window.open(`/chat/conversation/${conversationId}/export/`, '_blank');
  }

  // Get CSRF token
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  // Show toast notification
  function showToast(message, type = 'info') {
    const toastContainer = document.querySelector('.toast-container') || createToastContainer();
    
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.innerHTML = `
      <div class="toast-header">
        <i class="toast-icon fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
        <span class="toast-message">${message}</span>
        <button type="button" class="btn-close" onclick="this.parentElement.parentElement.remove()"></button>
      </div>
    `;
    
    toastContainer.appendChild(toast);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
      if (toast.parentElement) {
        toast.remove();
      }
    }, 5000);
  }

     // Create toast container if it doesn't exist
   function createToastContainer() {
     const container = document.createElement('div');
     container.className = 'toast-container';
     document.body.appendChild(container);
     return container;
   }
   
   // Media handling functions
   function openMediaModal(url, type) {
     const modal = document.getElementById('mediaModal');
     const content = document.getElementById('mediaModalContent');
     
     if (type === 'image') {
       content.innerHTML = `<img src="${url}" alt="Full size image">`;
     } else if (type === 'video') {
       content.innerHTML = `<video controls autoplay><source src="${url}" type="video/mp4"></video>`;
     }
     
     modal.classList.add('show');
     document.body.style.overflow = 'hidden';
   }
   
   function closeMediaModal() {
     const modal = document.getElementById('mediaModal');
     modal.classList.remove('show');
     document.body.style.overflow = 'auto';
   }
   
   // Close modal when clicking outside
   document.addEventListener('click', function(event) {
     const modal = document.getElementById('mediaModal');
     if (event.target === modal) {
       closeMediaModal();
     }
   });
   
   // Close modal with Escape key
   document.addEventListener('keydown', function(event) {
     if (event.key === 'Escape') {
       closeMediaModal();
     }
   });
   
   // Format file size
   function formatFileSize(bytes) {
     if (bytes === 0) return '0 B';
     const k = 1024;
     const sizes = ['B', 'KB', 'MB', 'GB'];
     const i = Math.floor(Math.log(bytes) / Math.log(k));
     return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
   }
   
   // Get file icon based on file extension
   function getFileIcon(fileName) {
     const extension = fileName.split('.').pop()?.toLowerCase();
     const iconMap = {
       'pdf': 'fas fa-file-pdf',
       'doc': 'fas fa-file-word',
       'docx': 'fas fa-file-word',
       'xls': 'fas fa-file-excel',
       'xlsx': 'fas fa-file-excel',
       'ppt': 'fas fa-file-powerpoint',
       'pptx': 'fas fa-file-powerpoint',
       'txt': 'fas fa-file-alt',
       'zip': 'fas fa-file-archive',
       'rar': 'fas fa-file-archive',
       '7z': 'fas fa-file-archive',
       'mp3': 'fas fa-file-audio',
       'wav': 'fas fa-file-audio',
       'mp4': 'fas fa-file-video',
       'avi': 'fas fa-file-video',
       'mov': 'fas fa-file-video',
       'jpg': 'fas fa-file-image',
       'jpeg': 'fas fa-file-image',
       'png': 'fas fa-file-image',
       'gif': 'fas fa-file-image'
     };
     
     return iconMap[extension] || 'fas fa-file';
   }
   
   // File upload handling
   let selectedFile = null;
   
   function handleFileUpload(event) {
     const file = event.target.files[0];
     if (!file) return;
     
     selectedFile = file;
     showFilePreview(file);
   }
   
   function showFilePreview(file) {
     const preview = document.getElementById('file-preview');
     const fileIcon = getFileIcon(file.name);
     const fileSize = formatFileSize(file.size);
     
     preview.innerHTML = `
       <div class="alert alert-info d-flex align-items-center justify-content-between">
         <div>
           <i class="${fileIcon} me-2"></i>
           <strong>${file.name}</strong> (${fileSize})
         </div>
         <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeFile()">
           <i class="fas fa-times"></i>
         </button>
       </div>
     `;
     preview.style.display = 'block';
   }
   
   function removeFile() {
     selectedFile = null;
     document.getElementById('file-preview').style.display = 'none';
     document.getElementById('file-input').value = '';
   }
   
   // Enhanced send message function to handle files
   function sendMessage() {
     const input = document.getElementById('message-input');
     const content = input.value.trim();
     
     if (!content && !selectedFile) return;
     
     if (selectedFile) {
       sendFileMessage(selectedFile, content);
     } else {
       sendTextMessage(content);
     }
   }
   
   function sendTextMessage(content) {
     // Clear input
     document.getElementById('message-input').value = '';
     
     // Add message to UI immediately (optimistic update)
     const tempMessage = {
       message_id: Date.now(),
       content: content,
       sender_type: 'admin',
       message_type: 'text',
       sent_at: new Date().toISOString(),
       status: 'sent'
     };
     
     appendMessage(tempMessage);
     
     // Send to API
     fetch(`/chat/admin/conversations/${conversationId}/send-message/`, {
       method: 'POST',
       headers: {
         'X-CSRFToken': getCookie('csrftoken'),
         'Content-Type': 'application/json',
       },
       body: JSON.stringify({ content: content })
     })
     .then(response => response.json())
     .then(data => {
       // Update the temporary message with real data
       updateMessage(tempMessage.message_id, data);
     })
     .catch(error => {
       console.error('Error sending message:', error);
       showToast('Error sending message', 'error');
       
       // Remove the temporary message
       removeMessage(tempMessage.message_id);
     });
   }
   
   function sendFileMessage(file, caption) {
     const formData = new FormData();
     formData.append('file', file);
     if (caption) {
       formData.append('content', caption);
     }
     
     // Add message to UI immediately (optimistic update)
     const tempMessage = {
       message_id: Date.now(),
       content: caption || '',
       sender_type: 'admin',
       message_type: getMessageType(file.type),
       media_url: URL.createObjectURL(file),
       sent_at: new Date().toISOString(),
       status: 'sending',
       metadata: {
         file_name: file.name,
         file_size: file.size
       }
     };
     
     appendMessage(tempMessage);
     
     // Send to API
     fetch(`/chat/admin/conversations/${conversationId}/send-message/`, {
       method: 'POST',
       headers: {
         'X-CSRFToken': getCookie('csrftoken'),
       },
       body: formData
     })
     .then(response => response.json())
     .then(data => {
       // Update the temporary message with real data
       updateMessage(tempMessage.message_id, data);
       removeFile();
     })
     .catch(error => {
       console.error('Error sending file:', error);
       showToast('Error sending file', 'error');
       
       // Remove the temporary message
       removeMessage(tempMessage.message_id);
     });
   }
   
   function getMessageType(mimeType) {
     if (mimeType.startsWith('image/')) return 'image';
     if (mimeType.startsWith('video/')) return 'video';
     if (mimeType.startsWith('audio/')) return 'audio';
     return 'file';
   }

</script>
{% endblock javascripts %}
