{% extends 'layouts/base.html' %}

{% block title %} Emergency Chat Conversations {% endblock title %}

<!-- Specific CSS goes HERE -->
{% block stylesheets %}
<style>
  .conversation-card {
    transition: all 0.3s ease;
    border-left: 4px solid #e9ecef;
  }
  
  .conversation-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
  }
  
  .conversation-card.status-new {
    border-left-color: #17a2b8;
  }
  
  .conversation-card.status-active {
    border-left-color: #28a745;
  }
  
  .conversation-card.status-resolved {
    border-left-color: #6c757d;
  }
  
  .conversation-card.status-closed {
    border-left-color: #dc3545;
  }
  
  .conversation-card.priority-urgent {
    border-left-color: #dc3545;
    border-left-width: 6px;
  }
  
  .conversation-card.priority-high {
    border-left-color: #fd7e14;
    border-left-width: 5px;
  }
  
  .conversation-card.priority-medium {
    border-left-color: #ffc107;
    border-left-width: 4px;
  }
  
  .conversation-card.priority-low {
    border-left-color: #28a745;
    border-left-width: 3px;
  }
  
  .status-badge {
    font-size: 0.75rem;
    font-weight: 600;
    padding: 0.25rem 0.5rem;
    border-radius: 0.375rem;
  }
  
  .priority-badge {
    font-size: 0.75rem;
    font-weight: 600;
    padding: 0.25rem 0.5rem;
    border-radius: 0.375rem;
  }
  
  .unread-indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background-color: #dc3545;
    display: inline-block;
    margin-right: 8px;
  }
  
  .chat-filters {
    background: #f8f9fa;
    border-radius: 0.5rem;
    padding: 1rem;
    margin-bottom: 1.5rem;
  }
  
  .conversation-meta {
    font-size: 0.875rem;
    color: #6c757d;
  }
  
  .assign-admin-btn {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
  }
</style>
{% endblock stylesheets %}

{% block content %}

    <!-- Header -->
    <div class="header bg-gradient-danger pb-6">
      <div class="container-fluid">
        <div class="header-body">
          <div class="row align-items-center py-2">
            <div class="col-lg-6 col-7">
              <h6 class="h3 text-white d-inline-block mb-0">Emergency Chat Conversations</h6>
              <nav aria-label="breadcrumb" class="d-none d-md-inline-block ml-md-4">
                <ol class="breadcrumb breadcrumb-links breadcrumb-dark">
                  <li class="breadcrumb-item"><a href="{% url 'home' %}"><i class="fas fa-home"></i></a></li>
                  <li class="breadcrumb-item active" aria-current="page">Emergency Chat</li>
                </ol>
              </nav>
            </div>
            <div class="col-lg-6 col-5 text-right">
              <button class="btn btn-sm btn-neutral" onclick="refreshConversations()">
                <i class="fas fa-sync-alt me-1"></i>Refresh
              </button>
              <button class="btn btn-sm btn-neutral" onclick="exportConversations()">
                <i class="fas fa-download me-1"></i>Export
              </button>
            </div>
          </div>
          
          <!-- Stats Cards -->
          <div class="row">
            <div class="col-xl-3 col-md-6">
              <div class="card card-stats">
                <div class="card-body">
                  <div class="row">
                    <div class="col">
                      <h5 class="card-title text-uppercase text-muted mb-0">Total Conversations</h5>
                      <span class="h2 font-weight-bold mb-0" id="total-conversations">-</span>
                    </div>
                    <div class="col-auto">
                      <div class="icon icon-shape bg-gradient-red text-white rounded-circle shadow">
                        <i class="fas fa-comments"></i>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-xl-3 col-md-6">
              <div class="card card-stats">
                <div class="card-body">
                  <div class="row">
                    <div class="col">
                      <h5 class="card-title text-uppercase text-muted mb-0">Active</h5>
                      <span class="h2 font-weight-bold mb-0" id="active-conversations">-</span>
                    </div>
                    <div class="col-auto">
                      <div class="icon icon-shape bg-gradient-green text-white rounded-circle shadow">
                        <i class="fas fa-comment-dots"></i>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-xl-3 col-md-6">
              <div class="card card-stats">
                <div class="card-body">
                  <div class="row">
                    <div class="col">
                      <h5 class="card-title text-uppercase text-muted mb-0">Unassigned</h5>
                      <span class="h2 font-weight-bold mb-0" id="unassigned-conversations">-</span>
                    </div>
                    <div class="col-auto">
                      <div class="icon icon-shape bg-gradient-orange text-white rounded-circle shadow">
                        <i class="fas fa-user-clock"></i>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-xl-3 col-md-6">
              <div class="card card-stats">
                <div class="card-body">
                  <div class="row">
                    <div class="col">
                      <h5 class="card-title text-uppercase text-muted mb-0">Urgent</h5>
                      <span class="h2 font-weight-bold mb-0" id="urgent-conversations">-</span>
                    </div>
                    <div class="col-auto">
                      <div class="icon icon-shape bg-gradient-danger text-white rounded-circle shadow">
                        <i class="fas fa-exclamation-triangle"></i>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Page content -->
    <div class="container-fluid mt--6">
      
      <!-- Chat Filters -->
      <div class="chat-filters">
        <div class="row">
          <div class="col-md-3">
            <label for="status-filter" class="form-label">Status</label>
            <select class="form-select" id="status-filter" onchange="filterConversations()">
              <option value="">All Statuses</option>
              <option value="new">New</option>
              <option value="active">Active</option>
              <option value="resolved">Resolved</option>
              <option value="closed">Closed</option>
            </select>
          </div>
          <div class="col-md-3">
            <label for="priority-filter" class="form-label">Priority</label>
            <select class="form-select" id="priority-filter" onchange="filterConversations()">
              <option value="">All Priorities</option>
              <option value="urgent">Urgent</option>
              <option value="high">High</option>
              <option value="medium">Medium</option>
              <option value="low">Low</option>
            </select>
          </div>
          <div class="col-md-3">
            <label for="admin-filter" class="form-label">Assigned Admin</label>
            <select class="form-select" id="admin-filter" onchange="filterConversations()">
              <option value="">All Admins</option>
              <option value="unassigned">Unassigned</option>
            </select>
          </div>
          <div class="col-md-3">
            <label for="search-filter" class="form-label">Search</label>
            <input type="text" class="form-control" id="search-filter" placeholder="Search conversations..." onkeyup="filterConversations()">
          </div>
        </div>
      </div>

      <!-- Conversations List -->
      <div class="row" id="conversations-container">
        <!-- Conversations will be loaded here dynamically -->
        <div class="col-12 text-center">
          <div class="spinner-border text-primary" role="status">
            <span class="sr-only">Loading...</span>
          </div>
          <p class="mt-2">Loading conversations...</p>
        </div>
      </div>

      <!-- Load More Button -->
      <div class="row mt-4" id="load-more-container" style="display: none;">
        <div class="col-12 text-center">
          <button class="btn btn-outline-primary" onclick="loadMoreConversations()">
            <i class="fas fa-plus me-1"></i>Load More Conversations
          </button>
        </div>
      </div>

    </div>

{% endblock content %}

<!-- Specific JS goes HERE -->
{% block javascripts %}
<script>
  let currentPage = 1;
  let hasMorePages = false;
  let currentFilters = {};

  // Load conversations on page load
  document.addEventListener('DOMContentLoaded', function() {
    loadConversations();
    loadStats();
  });

  // Load conversation statistics
  function loadStats() {
    fetch('/chat/admin/conversations/stats/', {
      headers: {
        'X-CSRFToken': getCookie('csrftoken'),
        'Content-Type': 'application/json',
      }
    })
    .then(response => response.json())
    .then(data => {
      document.getElementById('total-conversations').textContent = data.total || 0;
      document.getElementById('active-conversations').textContent = data.active || 0;
      document.getElementById('unassigned-conversations').textContent = data.unassigned || 0;
      document.getElementById('urgent-conversations').textContent = data.urgent || 0;
    })
    .catch(error => {
      console.error('Error loading stats:', error);
    });
  }

  // Load conversations
  function loadConversations(page = 1, append = false) {
    const filters = getCurrentFilters();
    const queryParams = new URLSearchParams({
      page: page,
      page_size: 20,
      ...filters
    });

    fetch(`/chat/admin/conversations/?${queryParams}`, {
      headers: {
        'X-CSRFToken': getCookie('csrftoken'),
        'Content-Type': 'application/json',
      }
    })
    .then(response => response.json())
    .then(data => {
      if (append) {
        appendConversations(data.results);
      } else {
        displayConversations(data.results);
      }
      
      hasMorePages = data.next !== null;
      currentPage = page;
      
      // Show/hide load more button
      const loadMoreContainer = document.getElementById('load-more-container');
      if (hasMorePages) {
        loadMoreContainer.style.display = 'block';
      } else {
        loadMoreContainer.style.display = 'none';
      }
    })
    .catch(error => {
      console.error('Error loading conversations:', error);
      showToast('Error loading conversations', 'error');
    });
  }

  // Display conversations
  function displayConversations(conversations) {
    const container = document.getElementById('conversations-container');
    
    if (conversations.length === 0) {
      container.innerHTML = `
        <div class="col-12 text-center">
          <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            No conversations found matching your criteria.
          </div>
        </div>
      `;
      return;
    }

    container.innerHTML = conversations.map(conversation => createConversationCard(conversation)).join('');
  }

  // Append conversations (for pagination)
  function appendConversations(conversations) {
    const container = document.getElementById('conversations-container');
    const newConversations = conversations.map(conversation => createConversationCard(conversation)).join('');
    
    // Remove the "no conversations" message if it exists
    const noConversationsAlert = container.querySelector('.alert-info');
    if (noConversationsAlert) {
      noConversationsAlert.remove();
    }
    
    container.insertAdjacentHTML('beforeend', newConversations);
  }

  // Create conversation card HTML
  function createConversationCard(conversation) {
    const statusClass = `status-${conversation.status}`;
    const priorityClass = `priority-${conversation.priority}`;
    const unreadIndicator = conversation.unread_count_admin > 0 ? '<span class="unread-indicator"></span>' : '';
    
    return `
      <div class="col-lg-6 col-xl-4 mb-4">
        <div class="card conversation-card ${statusClass} ${priorityClass} h-100">
          <div class="card-header pb-0">
            <div class="d-flex justify-content-between align-items-center">
              <h6 class="mb-0">
                ${unreadIndicator}
                <span class="text-truncate">${conversation.subject || 'Emergency Chat'}</span>
              </h6>
              <div class="dropdown">
                <button class="btn btn-sm btn-link text-muted" type="button" data-bs-toggle="dropdown">
                  <i class="fas fa-ellipsis-v"></i>
                </button>
                <ul class="dropdown-menu">
                  <li><a class="dropdown-item" href="/chat/conversation/${conversation.conversation_id}/">
                    <i class="fas fa-eye me-2"></i>View Conversation
                  </a></li>
                  <li><a class="dropdown-item" href="#" onclick="assignAdmin(${conversation.conversation_id})">
                    <i class="fas fa-user-plus me-2"></i>Assign Admin
                  </a></li>
                  <li><a class="dropdown-item" href="#" onclick="updateStatus(${conversation.conversation_id}, 'resolved')">
                    <i class="fas fa-check me-2"></i>Mark Resolved
                  </a></li>
                </ul>
              </div>
            </div>
          </div>
          <div class="card-body pt-0">
            <div class="mb-3">
              <span class="status-badge bg-${getStatusColor(conversation.status)} me-2">
                ${conversation.status.charAt(0).toUpperCase() + conversation.status.slice(1)}
              </span>
              <span class="priority-badge bg-${getPriorityColor(conversation.priority)}">
                ${conversation.priority.charAt(0).toUpperCase() + conversation.priority.slice(1)}
              </span>
            </div>
            
            <p class="card-text text-truncate mb-2">
              ${conversation.last_message || 'No messages yet'}
            </p>
            
            <div class="conversation-meta">
              <div class="row">
                <div class="col-6">
                  <small><i class="fas fa-mobile-alt me-1"></i>${conversation.mobile_session?.device_id || 'Unknown'}</small>
                </div>
                <div class="col-6 text-end">
                  <small><i class="fas fa-clock me-1"></i>${formatTime(conversation.last_message_at || conversation.created_at)}</small>
                </div>
              </div>
              
              <div class="row mt-2">
                <div class="col-6">
                  <small><i class="fas fa-user me-1"></i>${conversation.assigned_admin?.username || 'Unassigned'}</small>
                </div>
                <div class="col-6 text-end">
                  <small><i class="fas fa-comments me-1"></i>${conversation.messages_count || 0} messages</small>
                </div>
              </div>
            </div>
          </div>
          
          <div class="card-footer bg-transparent">
            <div class="d-flex justify-content-between align-items-center">
              <a href="/chat/conversation/${conversation.conversation_id}/" class="btn btn-sm btn-primary">
                <i class="fas fa-comments me-1"></i>Open Chat
              </a>
              ${conversation.assigned_admin ? '' : `
                <button class="btn btn-sm btn-outline-success assign-admin-btn" onclick="assignAdmin(${conversation.conversation_id})">
                  <i class="fas fa-user-plus me-1"></i>Assign
                </button>
              `}
            </div>
          </div>
        </div>
      </div>
    `;
  }

  // Get status color
  function getStatusColor(status) {
    const colors = {
      'new': 'info',
      'active': 'success',
      'resolved': 'secondary',
      'closed': 'danger'
    };
    return colors[status] || 'secondary';
  }

  // Get priority color
  function getPriorityColor(priority) {
    const colors = {
      'urgent': 'danger',
      'high': 'warning',
      'medium': 'info',
      'low': 'success'
    };
    return colors[priority] || 'info';
  }

  // Format time
  function formatTime(timeString) {
    if (!timeString) return 'Unknown';
    const date = new Date(timeString);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins}m ago`;
    if (diffHours < 24) return `${diffHours}h ago`;
    if (diffDays < 7) return `${diffDays}d ago`;
    return date.toLocaleDateString();
  }

  // Get current filters
  function getCurrentFilters() {
    return {
      status: document.getElementById('status-filter').value,
      priority: document.getElementById('priority-filter').value,
      admin: document.getElementById('admin-filter').value,
      search: document.getElementById('search-filter').value
    };
  }

  // Filter conversations
  function filterConversations() {
    currentPage = 1;
    loadConversations(1, false);
  }

  // Load more conversations
  function loadMoreConversations() {
    if (hasMorePages) {
      loadConversations(currentPage + 1, true);
    }
  }

  // Refresh conversations
  function refreshConversations() {
    currentPage = 1;
    loadConversations(1, false);
    loadStats();
  }

  // Assign admin to conversation
  function assignAdmin(conversationId) {
    // This will be implemented in the conversation detail view
    window.location.href = `/chat/conversation/${conversationId}/`;
  }

  // Update conversation status
  function updateStatus(conversationId, status) {
    fetch(`/chat/admin/conversations/${conversationId}/status/`, {
      method: 'PATCH',
      headers: {
        'X-CSRFToken': getCookie('csrftoken'),
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ status: status })
    })
    .then(response => response.json())
    .then(data => {
      showToast('Status updated successfully', 'success');
      refreshConversations();
    })
    .catch(error => {
      console.error('Error updating status:', error);
      showToast('Error updating status', 'error');
    });
  }

  // Export conversations
  function exportConversations() {
    const filters = getCurrentFilters();
    const queryParams = new URLSearchParams(filters);
    window.open(`/chat/admin/conversations/export/?${queryParams}`, '_blank');
  }

  // Get CSRF token
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  // Show toast notification
  function showToast(message, type = 'info') {
    const toastContainer = document.querySelector('.toast-container') || createToastContainer();
    
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.innerHTML = `
      <div class="toast-header">
        <i class="toast-icon fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
        <span class="toast-message">${message}</span>
        <button type="button" class="btn-close" onclick="this.parentElement.parentElement.remove()"></button>
      </div>
    `;
    
    toastContainer.appendChild(toast);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
      if (toast.parentElement) {
        toast.remove();
      }
    }, 5000);
  }

  // Create toast container if it doesn't exist
  function createToastContainer() {
    const container = document.createElement('div');
    container.className = 'toast-container';
    document.body.appendChild(container);
    return container;
  }

  // Auto-refresh every 30 seconds
  setInterval(() => {
    loadStats();
  }, 30000);

</script>
{% endblock javascripts %}
