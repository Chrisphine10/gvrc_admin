{% extends 'layouts/base.html' %}
{% load static %}

{% block title %} Geography Overview {% endblock title %}

{% block content %}
  <div class="container-fluid py-4">
    <!-- Statistics Cards -->
    <div class="row">
      <div class="col-md-3">
        <div class="card mb-4">
          <div class="card-body text-center">
            <h6>Counties</h6>
            <h3 class="mb-0">{{ counties|length }}</h3>
            <button class="btn btn-sm btn-primary mt-2 add-btn" data-type="county">
              <i class="fas fa-plus"></i> Add County
            </button>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card mb-4">
          <div class="card-body text-center">
            <h6>Constituencies</h6>
            <h3 class="mb-0">{{ total_constituencies }}</h3>
            <button class="btn btn-sm btn-primary mt-2 add-btn" data-type="constituency">
              <i class="fas fa-plus"></i> Add Constituency
            </button>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card mb-4">
          <div class="card-body text-center">
            <h6>Wards</h6>
            <h3 class="mb-0">{{ total_wards }}</h3>
            <button class="btn btn-sm btn-primary mt-2 add-btn" data-type="ward">
              <i class="fas fa-plus"></i> Add Ward
            </button>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card mb-4">
          <div class="card-body text-center">
            <h6>Facilities</h6>
            <h3 class="mb-0">{{ total_facilities }}</h3>
          </div>
        </div>
      </div>
    </div>

    <!-- Counties Table -->
    <div class="card">
      <div class="card-header pb-0">
        <h6>Counties</h6>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table mb-0">
            <thead>
              <tr>
                <th>County</th>
                <th class="text-center">Code</th>
                <th class="text-center">Constituencies</th>
                <th class="text-center">Wards</th>
                <th class="text-end">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for c in counties %}
                <tr>
                  <td class="text-sm">{{ c.county_name }}</td>
                  <td class="text-sm text-center">{{ c.county_code }}</td>
                  <td class="text-sm text-center">{{ c.constituency_count }}</td>
                  <td class="text-sm text-center">{{ c.ward_count }}</td>
                  <td class="text-sm text-end">
                    <a href="{% url 'common:county_detail' c.county_id %}" class="text-secondary mr-2">
                      <i class="fas fa-eye"></i>
                    </a>
                    <button class="btn btn-sm btn-outline-primary mr-1 edit-btn" 
                            data-type="county" 
                            data-id="{{ c.county_id }}" 
                            data-name="{{ c.county_name|escapejs }}" 
                            data-code="{{ c.county_code|escapejs }}">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger delete-btn" 
                            data-type="county" 
                            data-id="{{ c.county_id }}" 
                            data-name="{{ c.county_name|escapejs }}">
                      <i class="fas fa-trash"></i>
                    </button>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Add/Edit County Modal -->
  <div class="modal fade" id="countyModal" tabindex="-1" role="dialog" aria-labelledby="countyModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="countyModalLabel">Add New County</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form id="countyForm">
            <input type="hidden" id="countyId" name="id" value="">
            <div class="form-group">
              <label for="countyName">County Name</label>
              <input type="text" class="form-control" id="countyName" name="name" required>
            </div>
            <div class="form-group">
              <label for="countyCode">County Code</label>
              <input type="text" class="form-control" id="countyCode" name="code" required>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary save-btn" data-form="county">Save County</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add/Edit Constituency Modal -->
  <div class="modal fade" id="constituencyModal" tabindex="-1" role="dialog" aria-labelledby="constituencyModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="constituencyModalLabel">Add New Constituency</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form id="constituencyForm">
            <input type="hidden" id="constituencyId" name="id" value="">
            <div class="form-group">
              <label for="constituencyName">Constituency Name</label>
              <input type="text" class="form-control" id="constituencyName" name="name" required>
            </div>
            <div class="form-group">
              <label for="constituencyCode">Constituency Code</label>
              <input type="text" class="form-control" id="constituencyCode" name="code" required>
            </div>
            <div class="form-group">
              <label for="countySelect">County</label>
              <select class="form-control" id="countySelect" name="county_id" required>
                <option value="">Select a county</option>
              </select>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary save-btn" data-form="constituency">Save Constituency</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add/Edit Ward Modal -->
  <div class="modal fade" id="wardModal" tabindex="-1" role="dialog" aria-labelledby="wardModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="wardModalLabel">Add New Ward</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form id="wardForm">
            <input type="hidden" id="wardId" name="id" value="">
            <div class="form-group">
              <label for="wardName">Ward Name</label>
              <input type="text" class="form-control" id="wardName" name="name" required>
            </div>
            <div class="form-group">
              <label for="wardCode">Ward Code</label>
              <input type="text" class="form-control" id="wardCode" name="code" required>
            </div>
            <div class="form-group">
              <label for="constituencySelect">Constituency</label>
              <select class="form-control" id="constituencySelect" name="constituency_id" required>
                <option value="">Select a constituency</option>
              </select>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary save-btn" data-form="ward">Save Ward</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <p id="deleteMessage">Are you sure you want to delete this item?</p>
          <div id="facilityWarning" class="alert alert-warning" style="display: none;">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>Warning:</strong> This item has facilities connected to it and cannot be deleted. 
            You can only edit it to maintain data integrity.
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" id="deleteConfirmBtn" data-action="delete">Delete</button>
        </div>
      </div>
    </div>
  </div>
{% endblock content %}

{% block javascripts %}
<script>
let currentDeleteItem = null;
let isEditMode = false;

// Load counties and constituencies for dropdowns
document.addEventListener('DOMContentLoaded', function() {
    loadCounties();
    loadConstituencies();

    // Add event listeners for add buttons
    document.querySelectorAll('.add-btn').forEach(button => {
        button.addEventListener('click', function() {
            const type = this.dataset.type;
            openAddModal(type);
        });
    });

    // Add event listeners for edit buttons
    document.querySelectorAll('.edit-btn').forEach(button => {
        button.addEventListener('click', function() {
            const type = this.dataset.type;
            const id = this.dataset.id;
            const name = this.dataset.name;
            const code = this.dataset.code;
            editItem(type, id, name, code);
        });
    });

    // Add event listeners for delete buttons
    document.querySelectorAll('.delete-btn').forEach(button => {
        button.addEventListener('click', function() {
            const type = this.dataset.type;
            const id = this.dataset.id;
            const name = this.dataset.name;
            deleteItem(type, id, name);
        });
    });

    // Add event listeners for save buttons
    document.querySelectorAll('.save-btn').forEach(button => {
        button.addEventListener('click', function() {
            const formType = this.dataset.form;
            if (formType === 'county') {
                saveCounty();
            } else if (formType === 'constituency') {
                saveConstituency();
            } else if (formType === 'ward') {
                saveWard();
            }
        });
    });

    // Add event listener for delete confirmation button
    document.getElementById('deleteConfirmBtn').addEventListener('click', function() {
        confirmDelete();
    });
});

function loadCounties() {
    fetch('{% url "geography:get_all_counties" %}')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const countySelect = document.getElementById('countySelect');
                countySelect.innerHTML = '<option value="">Select a county</option>';
                data.counties.forEach(county => {
                    const option = document.createElement('option');
                    option.value = county.county_id;
                    option.textContent = county.county_name;
                    countySelect.appendChild(option);
                });
            }
        })
        .catch(error => console.error('Error loading counties:', error));
}

function loadConstituencies() {
    fetch('{% url "geography:get_all_constituencies" %}')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const constituencySelect = document.getElementById('constituencySelect');
                constituencySelect.innerHTML = '<option value="">Select a constituency</option>';
                data.constituencies.forEach(constituency => {
                    const option = document.createElement('option');
                    option.value = constituency.constituency_id;
                    option.textContent = `${constituency.constituency_name} (${constituency.county__county_name})`;
                    constituencySelect.appendChild(option);
                });
            }
        })
        .catch(error => console.error('Error loading constituencies:', error));
}

function openAddModal(type) {
    isEditMode = false;
    if (type === 'county') {
        document.getElementById('countyModalLabel').textContent = 'Add New County';
        document.getElementById('countyForm').reset();
        document.getElementById('countyId').value = '';
        $('#countyModal').modal('show');
    } else if (type === 'constituency') {
        document.getElementById('constituencyModalLabel').textContent = 'Add New Constituency';
        document.getElementById('constituencyForm').reset();
        document.getElementById('constituencyId').value = '';
        $('#constituencyModal').modal('show');
    } else if (type === 'ward') {
        document.getElementById('wardModalLabel').textContent = 'Add New Ward';
        document.getElementById('wardForm').reset();
        document.getElementById('wardId').value = '';
        $('#wardModal').modal('show');
    }
}

function editItem(type, id, name, code, countyId = null, constituencyId = null) {
    isEditMode = true;
    if (type === 'county') {
        document.getElementById('countyModalLabel').textContent = 'Edit County';
        document.getElementById('countyId').value = id;
        document.getElementById('countyName').value = name;
        document.getElementById('countyCode').value = code;
        $('#countyModal').modal('show');
    } else if (type === 'constituency') {
        document.getElementById('constituencyModalLabel').textContent = 'Edit Constituency';
        document.getElementById('constituencyId').value = id;
        document.getElementById('constituencyName').value = name;
        document.getElementById('constituencyCode').value = code;
        document.getElementById('countySelect').value = countyId;
        $('#constituencyModal').modal('show');
    } else if (type === 'ward') {
        document.getElementById('wardModalLabel').textContent = 'Edit Ward';
        document.getElementById('wardId').value = id;
        document.getElementById('wardName').value = name;
        document.getElementById('wardCode').value = code;
        document.getElementById('constituencySelect').value = constituencyId;
        $('#wardModal').modal('show');
    }
}

function saveCounty() {
    const form = document.getElementById('countyForm');
    const formData = new FormData(form);
    const countyId = formData.get('id');
    
    const data = {
        type: 'county',
        name: formData.get('name'),
        code: formData.get('code')
    };
    
    // Add ID if editing
    if (countyId) {
        data.id = countyId;
    }
    
    const url = countyId ? '{% url "geography:edit_geography_item" %}' : '{% url "geography:add_geography_item" %}';
    
    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Success', data.message, 'success');
            $('#countyModal').modal('hide');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast('Error', data.error, 'danger');
        }
    })
    .catch(error => {
        showToast('Error', 'An error occurred while saving the county', 'danger');
        console.error('Error:', error);
    });
}

function saveConstituency() {
    const form = document.getElementById('constituencyForm');
    const formData = new FormData(form);
    const constituencyId = formData.get('id');
    
    const data = {
        type: 'constituency',
        name: formData.get('name'),
        code: formData.get('code'),
        county_id: formData.get('county_id')
    };
    
    // Add ID if editing
    if (constituencyId) {
        data.id = constituencyId;
    }
    
    const url = constituencyId ? '{% url "geography:edit_geography_item" %}' : '{% url "geography:add_geography_item" %}';
    
    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Success', data.message, 'success');
            $('#constituencyModal').modal('hide');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast('Error', data.error, 'danger');
        }
    })
    .catch(error => {
        showToast('Error', 'An error occurred while saving the constituency', 'danger');
        console.error('Error:', error);
    });
}

function saveWard() {
    const form = document.getElementById('wardForm');
    const formData = new FormData(form);
    const wardId = formData.get('id');
    
    const data = {
        type: 'ward',
        name: formData.get('name'),
        code: formData.get('code'),
        constituency_id: formData.get('constituency_id')
    };
    
    // Add ID if editing
    if (wardId) {
        data.id = wardId;
    }
    
    const url = wardId ? '{% url "geography:edit_geography_item" %}' : '{% url "geography:add_geography_item" %}';
    
    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Success', data.message, 'success');
            $('#wardModal').modal('hide');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast('Error', data.error, 'danger');
        }
    })
    .catch(error => {
        showToast('Error', 'An error occurred while saving the ward', 'danger');
        console.error('Error:', error);
    });
}

function deleteItem(type, id, name) {
    currentDeleteItem = { type, id, name };
    
    // Check if item has facilities before showing delete modal
    fetch(`{% url "geography:check_facility_connections" %}?type=${type}&id=${id}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const hasFacilities = data.has_facilities;
                const warningDiv = document.getElementById('facilityWarning');
                const deleteBtn = document.getElementById('deleteConfirmBtn');
                
                if (hasFacilities) {
                    // Show warning and disable delete button
                    warningDiv.style.display = 'block';
                    deleteBtn.disabled = true;
                    deleteBtn.innerHTML = '<i class="fas fa-lock"></i> Cannot Delete';
                    deleteBtn.className = 'btn btn-secondary';
                } else {
                    // Hide warning and enable delete button
                    warningDiv.style.display = 'none';
                    deleteBtn.disabled = false;
                    deleteBtn.innerHTML = 'Delete';
                    deleteBtn.className = 'btn btn-danger';
                }
                
                document.getElementById('deleteMessage').textContent = `Are you sure you want to delete ${type} "${name}"?`;
                $('#deleteModal').modal('show');
            } else {
                showToast('Error', 'Failed to check facility connections', 'danger');
            }
        })
        .catch(error => {
            console.error('Error checking facility connections:', error);
            // Fallback to showing delete modal without facility check
            document.getElementById('facilityWarning').style.display = 'none';
            document.getElementById('deleteConfirmBtn').disabled = false;
            document.getElementById('deleteConfirmBtn').innerHTML = 'Delete';
            document.getElementById('deleteConfirmBtn').className = 'btn btn-danger';
            document.getElementById('deleteMessage').textContent = `Are you sure you want to delete ${type} "${name}"?`;
            $('#deleteModal').modal('show');
        });
}

function confirmDelete() {
    if (!currentDeleteItem) return;
    
    const data = {
        type: currentDeleteItem.type,
        id: currentDeleteItem.id
    };
    
    fetch('{% url "geography:delete_geography_item" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Success', data.message, 'success');
            $('#deleteModal').modal('hide');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast('Error', data.error, 'danger');
        }
    })
    .catch(error => {
        showToast('Error', 'An error occurred while deleting the item', 'danger');
        console.error('Error:', error);
    });
}

function showToast(title, message, type = 'info') {
    // Use the existing toast system from the base template
    if (window.toastManager) {
        window.toastManager.show(message, type, title);
    } else {
        // Fallback to alert if toast system is not available
        alert(`${title}: ${message}`);
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock javascripts %}
