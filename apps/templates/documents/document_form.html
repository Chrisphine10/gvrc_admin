{% extends 'layouts/base.html' %}
{% load static %}

{% block title %} {{ action }} Document {% endblock title %}

{% block content %}
  <div class="container-fluid py-4">
    
    <!-- Header with breadcrumb navigation -->
    <div class="row">
      <div class="col-12">
        <nav aria-label="breadcrumb" class="mb-3">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'home' %}">Dashboard</a></li>
            <li class="breadcrumb-item"><a href="{% url 'facilities:facility_list' %}">Facilities</a></li>
            <li class="breadcrumb-item"><a href="{% url 'documents:document_list' %}">Documents</a></li>
            <li class="breadcrumb-item active" aria-current="page">{{ action }} Document</li>
          </ol>
        </nav>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="d-flex justify-content-end">
          <a href="{% url 'documents:document_list' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to Documents
          </a>
        </div>
      </div>
    </div>
    <div class="row justify-content-center">
      <div class="col-lg-10">
        <div class="card">
          <div class="card-header">
            <h3 class="mb-0">{{ action }} Document</h3>
          </div>
          <div class="card-body">
            {% if messages %}
              {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                  {{ message }}
                  <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
              {% endfor %}
            {% endif %}

            <form method="post" enctype="multipart/form-data">
              {% csrf_token %}
              
              <!-- Basic Information -->
              <div class="row">
                <div class="col-lg-8">
                  <div class="form-group">
                    <label for="{{ form.title.id_for_label }}" class="form-control-label">Document Title *</label>
                    {{ form.title }}
                    {% if form.title.errors %}
                      <div class="text-danger">
                        {% for error in form.title.errors %}
                          <small>{{ error }}</small>
                        {% endfor %}
                      </div>
                    {% endif %}
                    <small class="form-text text-muted">
                      Provide a clear, descriptive title for the document.
                    </small>
                  </div>
                </div>
                <div class="col-lg-4">
                  <div class="form-group">
                    <label for="{{ form.document_type.id_for_label }}" class="form-control-label">Document Type *</label>
                    {{ form.document_type }}
                    {% if form.document_type.errors %}
                      <div class="text-danger">
                        {% for error in form.document_type.errors %}
                          <small>{{ error }}</small>
                        {% endfor %}
                      </div>
                    {% endif %}
                    <small class="form-text text-muted">
                      Choose the appropriate category for this document.
                    </small>
                  </div>
                </div>
              </div>

              <div class="form-group">
                <label for="{{ form.description.id_for_label }}" class="form-control-label">Description</label>
                {{ form.description }}
                {% if form.description.errors %}
                  <div class="text-danger">
                    {% for error in form.description.errors %}
                      <small>{{ error }}</small>
                    {% endfor %}
                  </div>
                {% endif %}
                <small class="form-text text-muted">
                  Describe what this document contains and its purpose.
                </small>
              </div>

              <!-- File Upload Section -->
              <div class="form-group">
                <label for="{{ form.file.id_for_label }}" class="form-control-label">Upload Document File</label>
                <div class="custom-file">
                  {{ form.file }}
                  <label class="custom-file-label" for="{{ form.file.id_for_label }}" id="file-label">
                    Choose file...
                  </label>
                </div>
                {% if form.file.errors %}
                  <div class="text-danger">
                    {% for error in form.file.errors %}
                      <small>{{ error }}</small>
                    {% endfor %}
                  </div>
                {% endif %}
                <small class="form-text text-muted">
                  Upload a document file (PDF, DOC, DOCX, TXT, RTF, or ODT). Maximum size: 10MB.
                </small>
                <div id="file-preview" class="mt-2" style="display: none;">
                  <div class="alert alert-info">
                    <i class="fas fa-file"></i>
                    <span id="file-info"></span>
                  </div>
                </div>
              </div>

              <!-- File Information (Legacy) -->
              <div class="row">
                <div class="col-lg-6">
                  <div class="form-group">
                    <label for="{{ form.external_url.id_for_label }}" class="form-control-label">File URL</label>
                    {{ form.external_url }}
                    {% if form.external_url.errors %}
                      <div class="text-danger">
                        {% for error in form.external_url.errors %}
                          <small>{{ error }}</small>
                        {% endfor %}
                      </div>
                    {% endif %}
                    <small class="form-text text-muted">
                      Optional: Provide a direct link to the document file.
                    </small>
                  </div>
                </div>
                <div class="col-lg-6">
                  <div class="form-group">
                    <label class="form-control-label">File Name</label>
                    <input 
                      type="text" 
                      class="form-control" 
                      id="file_name_display" 
                      placeholder="document.pdf"
                      readonly
                    >
                    <small class="form-text text-muted">
                      Original filename will be displayed after upload.
                    </small>
                  </div>
                </div>
              </div>

              <div class="form-group">
                <label for="{{ form.content.id_for_label }}" class="form-control-label">Document Content</label>
                {{ form.content }}
                {% if form.content.errors %}
                  <div class="text-danger">
                    {% for error in form.content.errors %}
                      <small>{{ error }}</small>
                    {% endfor %}
                  </div>
                {% endif %}
                <small class="form-text text-muted">
                  For text-based documents, you can enter the content directly here.
                </small>
              </div>

              <!-- Media & Links -->
              <div class="row">
                <div class="col-lg-6">
                  <div class="form-group">
                    <label for="{{ form.gbv_category.id_for_label }}" class="form-control-label">GBV Category</label>
                    {{ form.gbv_category }}
                    {% if form.gbv_category.errors %}
                      <div class="text-danger">
                        {% for error in form.gbv_category.errors %}
                          <small>{{ error }}</small>
                        {% endfor %}
                      </div>
                    {% endif %}
                    <small class="form-text text-muted">
                      Optional: Categorize by Gender-Based Violence type if applicable.
                    </small>
                  </div>
                </div>
                <div class="col-lg-6">
                  <div class="form-group">
                    <label for="{{ form.image_url.id_for_label }}" class="form-control-label">Image URL</label>
                    {{ form.image_url }}
                    {% if form.image_url.errors %}
                      <div class="text-danger">
                        {% for error in form.image_url.errors %}
                          <small>{{ error }}</small>
                        {% endfor %}
                      </div>
                    {% endif %}
                    <small class="form-text text-muted">
                      Optional: Provide a link to a related image or thumbnail.
                    </small>
                  </div>
                </div>
              </div>

              <!-- Settings -->
              <div class="row">
                <div class="col-lg-6">
                  <div class="form-group">
                    <div class="custom-control custom-switch">
                      {{ form.is_public }}
                      <label class="custom-control-label" for="{{ form.is_public.id_for_label }}">
                        Make this document public
                      </label>
                    </div>
                    {% if form.is_public.errors %}
                      <div class="text-danger">
                        {% for error in form.is_public.errors %}
                          <small>{{ error }}</small>
                        {% endfor %}
                      </div>
                    {% endif %}
                    <small class="form-text text-muted">
                      Public documents are visible to all users. Private documents are restricted.
                    </small>
                  </div>
                </div>
                <div class="col-lg-6">
                  <div class="form-group">
                    <label class="form-control-label">Uploaded By</label>
                    <input type="text" class="form-control" value="{{ request.user.full_name }}" readonly>
                    <small class="form-text text-muted">
                      This document will be associated with your user account.
                    </small>
                  </div>
                </div>
              </div>

              <!-- Document Examples -->
              <div class="form-group">
                <label class="form-control-label">Document Examples</label>
                <div class="row">
                  <div class="col-md-6">
                    <div class="card bg-light">
                      <div class="card-body p-3">
                        <h6 class="card-title text-primary">Common Document Types</h6>
                        <ul class="list-unstyled mb-0">
                          <li><small>• <strong>Reports:</strong> Monthly, quarterly, annual reports</small></li>
                          <li><small>• <strong>Policies:</strong> Guidelines, procedures, standards</small></li>
                          <li><small>• <strong>Forms:</strong> Applications, surveys, checklists</small></li>
                          <li><small>• <strong>Training:</strong> Manuals, guides, presentations</small></li>
                        </ul>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="card bg-light">
                      <div class="card-body p-3">
                        <h6 class="card-title text-success">Best Practices</h6>
                        <ul class="list-unstyled mb-0">
                          <li><small>• Use descriptive titles</small></li>
                          <li><small>• Provide clear descriptions</small></li>
                          <li><small>• Choose appropriate categories</small></li>
                          <li><small>• Set proper visibility levels</small></li>
                        </ul>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Next Steps -->
              <div class="form-group">
                <label class="form-control-label">Next Steps</label>
                <div class="alert alert-info">
                  <i class="fas fa-info-circle"></i>
                  <strong>After {{ action|lower }}ing this document:</strong>
                  <ol class="mb-0 mt-2">
                    <li>Review the document details and ensure accuracy</li>
                    <li>Set appropriate visibility (public/private) based on content</li>
                    <li>Consider adding relevant tags or categories</li>
                    <li>Share with appropriate team members if needed</li>
                  </ol>
                </div>
              </div>

              <div class="text-center">
                <button type="submit" class="btn btn-primary btn-lg">
                  <i class="fas fa-save"></i> {{ action }} Document
                </button>
                <a href="{% url 'documents:document_list' %}" class="btn btn-secondary btn-lg ml-2">
                  <i class="fas fa-times"></i> Cancel
                </a>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock content %}

{% block javascripts %}
  <script>
    $(document).ready(function() {
      // File upload preview and validation
      $('#{{ form.file.id_for_label }}').on('change', function(e) {
        const file = e.target.files[0];
        const filePreview = $('#file-preview');
        const fileInfo = $('#file-info');
        const fileLabel = $('#file-label');
        const fileNameDisplay = $('#file_name_display');
        
        if (file) {
          // Update file label
          fileLabel.text(file.name);
          
          // Show file preview
          const fileSize = (file.size / (1024 * 1024)).toFixed(2);
          const fileExtension = file.name.split('.').pop().toLowerCase();
          const allowedExtensions = ['pdf', 'doc', 'docx', 'txt', 'rtf', 'odt'];
          
          let fileIcon = 'fas fa-file';
          if (fileExtension === 'pdf') fileIcon = 'fas fa-file-pdf text-danger';
          else if (['doc', 'docx'].includes(fileExtension)) fileIcon = 'fas fa-file-word text-primary';
          else if (fileExtension === 'txt') fileIcon = 'fas fa-file-alt text-secondary';
          
          fileInfo.html(`
            <i class="${fileIcon}"></i>
            <strong>${file.name}</strong> 
            <span class="text-muted">(${fileSize} MB)</span>
            <br>
            <small class="text-muted">Type: ${fileExtension.toUpperCase()}</small>
          `);
          
          // Update filename display
          fileNameDisplay.val(file.name);
          
          // Validate file
          if (!allowedExtensions.includes(fileExtension)) {
            filePreview.removeClass('alert-info').addClass('alert-danger');
            fileInfo.append('<br><small class="text-danger">⚠️ File type not allowed. Please upload a document file.</small>');
          } else if (file.size > 10 * 1024 * 1024) { // 10MB limit
            filePreview.removeClass('alert-info').addClass('alert-warning');
            fileInfo.append('<br><small class="text-warning">⚠️ File size exceeds 10MB limit.</small>');
          } else {
            filePreview.removeClass('alert-danger alert-warning').addClass('alert-success');
            fileInfo.append('<br><small class="text-success">✓ File ready for upload</small>');
          }
          
          filePreview.show();
        } else {
          // Reset when no file selected
          fileLabel.text('Choose file...');
          filePreview.hide();
          fileNameDisplay.val('');
        }
      });
      
      // Form validation
      $('form').on('submit', function(e) {
        const title = $('#{{ form.title.id_for_label }}').val().trim();
        const documentType = $('#{{ form.document_type.id_for_label }}').val();
        const file = $('#{{ form.file.id_for_label }}')[0].files[0];
        const content = $('#{{ form.content.id_for_label }}').val().trim();
        const externalUrl = $('#{{ form.external_url.id_for_label }}').val().trim();
        
        // Clear previous validation errors
        $('.is-invalid').removeClass('is-invalid');
        $('.invalid-feedback').remove();
        
        let hasErrors = false;
        
        // Validate title
        if (!title) {
          $('#{{ form.title.id_for_label }}').addClass('is-invalid');
          $('#{{ form.title.id_for_label }}').after('<div class="invalid-feedback">Document title is required.</div>');
          hasErrors = true;
        } else if (title.length < 3) {
          $('#{{ form.title.id_for_label }}').addClass('is-invalid');
          $('#{{ form.title.id_for_label }}').after('<div class="invalid-feedback">Document title must be at least 3 characters long.</div>');
          hasErrors = true;
        }
        
        // Validate document type
        if (!documentType) {
          $('#{{ form.document_type.id_for_label }}').addClass('is-invalid');
          $('#{{ form.document_type.id_for_label }}').after('<div class="invalid-feedback">Document type is required.</div>');
          hasErrors = true;
        }
        
        // Validate that at least one content source is provided
        if (!file && !content && !externalUrl) {
          // Add error to all three fields
          $('#{{ form.file.id_for_label }}').addClass('is-invalid');
          $('#{{ form.content.id_for_label }}').addClass('is-invalid');
          $('#{{ form.external_url.id_for_label }}').addClass('is-invalid');
          
          $('#{{ form.file.id_for_label }}').after('<div class="invalid-feedback">Please provide either a file upload, content, or external URL.</div>');
          $('#{{ form.content.id_for_label }}').after('<div class="invalid-feedback">Please provide either a file upload, content, or external URL.</div>');
          $('#{{ form.external_url.id_for_label }}').after('<div class="invalid-feedback">Please provide either a file upload, content, or external URL.</div>');
          
          hasErrors = true;
        }
        
        // Validate file if provided
        if (file) {
          const fileExtension = file.name.split('.').pop().toLowerCase();
          const allowedExtensions = ['pdf', 'doc', 'docx', 'txt', 'rtf', 'odt'];
          
          if (!allowedExtensions.includes(fileExtension)) {
            $('#{{ form.file.id_for_label }}').addClass('is-invalid');
            $('#{{ form.file.id_for_label }}').after('<div class="invalid-feedback">File type not allowed. Please upload a document file (PDF, DOC, DOCX, TXT, RTF, or ODT).</div>');
            hasErrors = true;
          } else if (file.size > 10 * 1024 * 1024) { // 10MB limit
            $('#{{ form.file.id_for_label }}').addClass('is-invalid');
            $('#{{ form.file.id_for_label }}').after('<div class="invalid-feedback">File size exceeds the maximum allowed size of 10 MB.</div>');
            hasErrors = true;
          }
        }
        
        if (hasErrors) {
          e.preventDefault();
          // Scroll to first error
          const firstError = $('.is-invalid').first();
          if (firstError.length) {
            $('html, body').animate({
              scrollTop: firstError.offset().top - 100
            }, 500);
            firstError.focus();
          }
          return false;
        }
      });
      
      // Auto-hide alerts after 5 seconds
      setTimeout(function() {
        $('.alert').fadeOut('slow');
      }, 5000);
      
      // Clear validation errors on input
      $('input, textarea, select').on('input change', function() {
        $(this).removeClass('is-invalid');
        $(this).siblings('.invalid-feedback').remove();
      });
    });
  </script>
{% endblock javascripts %}
